<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GT RoboCup SSL: Kicker Firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rj_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GT RoboCup SSL
   </div>
   <div id="projectbrief">Soccer software, robot firmware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__kicker.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Kicker Firmware </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document was originally written Fall of 2019 after the mtrain implementation. The latest relevant branch was comp2019. Knowing robocup, this won't be updated to the latest version of firmware, but hopefully it will still describe most everything. - Joe Neiger</p>
<p>This document will go through the two modes of operation, standard and debug, and give full details on other specifics of operation, such as communication protocol, voltage reading, SPI operation, kick timings.</p>
<h2>Standard</h2>
<p>Standard mode takes commands from mtrain, acts on those commands, and returns the latest sensor data. This loop acts continuously.</p>
<ol type="1">
<li>A kick command will be sent to the kicker from mtrain over SPI.</li>
<li>The attiny will respond to this command by filling the global command structure with the given data. This includes kick type, power, and whether it is safe to charge.</li>
<li>The current voltage on the caps will be read.</li>
<li>If there is still room to charge to a higher voltage and we are safe to charge, we will do so.</li>
<li>If we are given a kick or chip command, we will then execute that kick.</li>
<li>Ball sense is read to see if a ball is breaking line of sight between the LED and photo resistor.</li>
<li>The current voltage and ball sense is sent back to the mtrain.</li>
</ol>
<h2>Debug</h2>
<p>Debug mode is special. All actions are fully controlled by the buttons on the side. Only voltage reading and ball sense still occur automatically.</p>
<p>The charge button toggles the safe to charge variable which allows the device to charge up to the max safe charge level controlled by software.</p>
<p>The kick button forces a kick immediately, discharging the caps through the kicker solenoid.</p>
<p>The chip button forces a chip immediately, discharging the caps through the chipper solenoid.</p>
<h2>Command Protocol</h2>
<p>See <code>kicker_commands.h</code></p>
<p>In the old'en days, aka Spring of 2019 and before, we used to send multiple SPI transactions to the kicker to fully describe out commands. This was very inefficient due to the lag associated with the attiny processing the transition. It was at least 100 ms delay before another transaction can occur.</p>
<p>This new protocol was built to send the entire packet in a single byte. Each bit represents a different thing.</p>
<h3>mtrain -&gt; kicker</h3>
<p>The lowest 4 bits (0 - 3) represent the power of the kick. 0 is min power, 15 is max power.</p>
<p>The next bit (4) represents whether the kicker can safely charge the caps or not. 0 is don't charge, 1 is charge</p>
<p>The next two bits (5 - 6) represent the type of kick activation. Specifically, whether you want to kick immediately, kick on breakbeam, or cancel a kick on breakbeam. 0b00 is do nothing, 0b01 is kick on breakbeam, 0b10 is kick immediately, 0b11 is to cancel a kick on breakbeam. Kick in this case means a kick or chip.</p>
<p>The most significant bit is what type of kick action is being taken. 0 is a linear kick on the ground, 1 is a chip.</p>
<h3>kicker -&gt; mtrain</h3>
<p>For the return from the kicker to mtrain, the only data that needs to go back is whether the breakbeam has tripped and the current voltage of the kicker. This allows for a very simple protocol.</p>
<p>The lowest 7 bits (0 - 6) define the voltage. The voltage is in units of adc_lsb/2. So <code>packet_voltage = adc_voltage / 2</code>. Multiple the packet voltage by 2 to get back to the adc lsb unit scale. This very roughly correlates to voltage.</p>
<p>The most significant bit is whether the break beam has tripped. 0 is not tripped (no ball), 1 is tripped (has ball)</p>
<h2>SPI Communication</h2>
<p>SPI as a protocol is interesting due to the syncronice method of data transfer. Each side has a letter filled with information and they send them to each other at the same time. Due to this, it is not possible to react to a command coming in until the next message transfer.</p>
<p>AVR on this specific device uses an interrupt to tell the user that a SPI transaction occurred (<code>SPI_STC_vect</code>). This interrupt fires after the entire byte has been transferred and is now held in <code>SPDR</code>. We pull this byte out and set a global command struct to hold the corresponding data. Interrupt lengths must be very short otherwise the processor will never actually run the normal code.</p>
<p>At the same time we receive that byte, the processor automatically sends whatever data used to be in <code>SPDR</code> to the other device. It is for this reason we continuously update that with the latest data. The kicker doesn't control the time this SPI transaction occurs so it must always be ready.</p>
<p>Note: When acting on the <code>SPDR</code> register, never operate on the register (eg <code>SPDR &amp; 0x2</code>), always fully copy the data over. Between two subsequent lines, this value can change due to the interrupt firing again.</p>
<h2>Voltage Reading</h2>
<p>The attiny has a built in analog to digital converter. This takes the analog voltage out the physical trace and converts it to a unitless number. This number is 0 - 255 which corresponds to 0V - Vcc on the physical line. Every 1000 iterations, the device reads the adc and saves it into the current global voltage variable. It is every 1000 iterations because there is a short lag time before starting the adc reading and actually getting the result. This lags the global loop causing a potential slowdown. Additionally, it's not that important that it is updated more than every 10 ms anyways.</p>
<p>Note: Based on the current resistor values on the board, the output of the adc very roughly correspond to the voltage of the board in volts. AKA 200 lsb out of the adc is just about 200 V on the high side</p>
<h2>The Kick Itself</h2>
<p>For the kick, the idea is to allow the pathway between the caps and the solenoid to stay open for a specific amount of time, allowing current to flow through and cause the kick.</p>
<p>Since this is such a specific time, we use a timer interrupt to make sure it's consistent. A timer interrupt, once enabled, calls a function (<code>TIMER0_COMPA_vect</code>) every X amount of time. When a kick is supposed to happen, we start the timer, and after it has finished, we stop the timer.</p>
<p>Inside this interrupt we must be very careful. We do not want to be charging while the channel is open. This forces us to create 4 phases to the kick. The first phase is when we stop the charging, the second state is when we start the kick, the third state is when we end the kick, the fourth state we start charging again. Each phase has a specific timing, not just the kick itself. This is because the time scale we are seeing at this level is close enough to the regime where we must account for the transitions of the charging circuit as well as the transistors that control the free flow into the solenoids.</p>
<h2>Ball Sense</h2>
<p>Ball sense filters the output of the sensor to clear false positives. It must be the same value for X amount of time to force the measurement to shift from <code>has_ball</code> to <code>not_has_ball</code> and back. More advanced and creative filtering techniques can be used, but since the kicker only talks to mtrain at 25-100 hz, it is not needed as the bulk of the delay is on the communication side, not the filter side. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jun 8 2020 00:49:57 for GT RoboCup SSL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
