#!/usr/bin/env python
# -*- coding: utf-8 -*-

import socket
import struct
from messages_robocup_ssl_wrapper_pb2 import *

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
sock.bind(('', 10002))
mreq = struct.pack("4sl", socket.inet_aton("224.5.23.2"), socket.htonl(socket.INADDR_ANY))
sock.setsockopt(socket.IPPROTO_IP, socket.IP_ADD_MEMBERSHIP, mreq)

files = {}
def get_file(name):
	if name in files:
		return files[name]
	else:
		files[name] = file(name + '.txt', 'wt')
		return files[name]

def emit_ball(ball):
	f = get_file('ball')
	print >> f, ball.x, ball.y

def emit_robot(team, robot):
	name = '%s_%d' % (team, robot.robot_id)
	f = get_file(name)
	print >> f, robot.x, robot.y, robot.orientation

wrapper = SSL_WrapperPacket()
try:
	while True:
		buf = sock.recv(10240)
		wrapper.ParseFromString(buf)
		if wrapper.HasField('detection'):
			detection = wrapper.detection;
			for r in detection.robots_blue:
				emit_robot('blue', r)
			for r in detection.robots_yellow:
				emit_robot('yellow', r)
			
			if len(detection.balls) > 0:
				emit_ball(detection.balls[0])
except:
	print
	for f in files:
		files[f].close()
